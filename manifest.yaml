apiVersion: apps/v1
kind: DaemonSet 
metadata:
  labels:
    app: logtailer
    ServiceName: logtailer
    Environment: dev
  name: logtailer
spec:
  selector:
    matchLabels:
      ServiceName: logtailer
      Environment: dev
      app: logtailer
  template:
    metadata:
      labels:
        app: logtailer
    spec:
      serviceAccount: sidecar
      imagePullSecrets:
      - name: privaterepoauth
      initContainers:
      - name: vault-init
        image: quay.io/shimmur/vault-init:d1322e9
        volumeMounts:
        - name: vault-vars
          mountPath: "/vault"
        env:
        - name: NEW_RELIC_LICENSE_KEY
          value: vault://secret/infra/newrelic?key=license
        - name: FILENAME
          value: "/vault/.init-env"
        command:
        - "/vault-init"
      containers:
      - image: quay.io/shimmur/logtailer:e6023cc-local-build
        name: alpine
        resources:
          requests:
            cpu: 0.2
            memory: 64Mi
          limits:
            cpu: 0.2
            memory: 64Mi
        env:
        - name: ENVIRONMENT
          value: dev
        - name: NEW_RELIC_ACCOUNT
          value: '2192796'
        - name: SYSLOG_ADDRESS
          value: '10.0.12.173'
        - name: HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: K8S_CLUSTER_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        volumeMounts:
          - name: host-mount
            mountPath: /var/log
      volumes:
        - name: host-mount
          hostPath:
            path: /var/log 
